___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Persist Campaign Data",
  "categories": ["ANALYTICS", "UTILITY"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "This template preserves the landing page URL and referrer string in a browser cookie, and pushes the original location into \u003ccode\u003edataLayer\u003c/code\u003e.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "CHECKBOX",
    "name": "storeInCookieOption",
    "checkboxText": "Store campaign data in a browser cookie",
    "simpleValueType": true,
    "help": "Select this option to save the page URL in a browser cookie \u003cstrong\u003eif\u003c/strong\u003e it has campaign defining parameters (utm_*, gclid). The referrer string is also saved in a cookie \u003cstrong\u003eif\u003c/strong\u003e its hostname differs from the current one."
  },
  {
    "type": "CHECKBOX",
    "name": "originalLocationOption",
    "checkboxText": "Push original location in \u003ccode\u003edataLayer\u003c/code\u003e",
    "simpleValueType": true,
    "help": "Select this option to push the current URL into \u003ccode\u003edataLayer\u003c/code\u003e. This is useful on single-page apps with \u003ca href\u003d\"https://www.simoahava.com/gtm-tips/fix-rogue-referral-problem-single-page-sites/\"\u003erogue referral\u003c/a\u003e issues. To be effective, this tag should only fire on the initial page load and not on subsequent SPA page events."
  },
  {
    "type": "GROUP",
    "name": "storeInCookie",
    "displayName": "Store campaign data in a cookie",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "triggerParameters",
        "displayName": "URL parameters that trigger the storage",
        "simpleValueType": true,
        "help": "Comma-separated list of parameters that trigger storage. If the URL has any one of these, then the browser cookie will be updated with the current URL.",
        "defaultValue": "utm_source,utm_medium,utm_campaign,utm_term,utm_content,utm_id,gclid",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "urlCookieName",
        "displayName": "Campaign URL cookie name",
        "simpleValueType": true,
        "help": "Cookie name where to save the URL with the campaign parameters. The cookie will be a \u003cstrong\u003esession cookie\u003c/strong\u003e written on the parent domain and root path. \u003cstrong\u003eIf you change the cookie name, remember to update the template permissions!\u003c/strong\u003e",
        "defaultValue": "__gtm_campaign_url",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "referrerCookieName",
        "displayName": "Referrer cookie name",
        "simpleValueType": true,
        "help": "Cookie name where to save the referrer string when the referrer hostname differs from the current hostname. The cookie will be a \u003cstrong\u003esession cookie\u003c/strong\u003e written on the parent domain and root path. \u003cstrong\u003eIf you change the cookie name, remember to update the template permissions!\u003c/strong\u003e",
        "defaultValue": "__gtm_referrer",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "storeInCookieOption",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "pushToDataLayer",
    "displayName": "Data Layer options for original location",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "dataLayerName",
        "displayName": "Name of the dataLayer array",
        "simpleValueType": true,
        "defaultValue": "dataLayer",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "dataLayerKey",
        "displayName": "Key name in dataLayer for the original location",
        "simpleValueType": true,
        "defaultValue": "originalLocation",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "originalLocationOption",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const getUrl = require('getUrl');
const getReferrerUrl = require('getReferrerUrl');
const createQueue = require('createQueue');
const setCookie = require('setCookie');
const queryPermission = require('queryPermission');
const log = require('logToConsole');

let fail = false;

if (data.storeInCookieOption) {
  // Check if URL has any of the params listed
  const paramsToFind = data.triggerParameters.split(',');
  const queryString = getUrl('query');
  const queryParams = queryString.length ? queryString.split('&') : [];
  if (queryParams.filter(pair => paramsToFind.indexOf(pair.split('=')[0]) > -1).length) {
    if (queryPermission('set_cookies', data.urlCookieName)) {
      setCookie(data.urlCookieName, getUrl(), {
        domain: 'auto',
        path: '/'
      });
    } else {
      log('Invalid permissions for writing ' + data.urlCookieName + ' cookie!');
      fail = true;
    }
  }
  
  // Check if referrer host does not contain current hostname
  const referrerHost = getReferrerUrl('host');
  if (referrerHost.indexOf(getUrl('host')) === -1 && referrerHost !== '') {
    if (queryPermission('set_cookies', data.referrerCookieName)) {
      setCookie(data.referrerCookieName, getReferrerUrl(), {
        domain: 'auto',
        path: '/'
      });
    } else {
      log('Invalid permissions for writing ' + data.referrerCookieName + ' cookie!');
      fail = true;
    }
  }
}

if (data.originalLocationOption) {
  // Push the current URL into dataLayer with the given key
  if (queryPermission('access_globals', 'readwrite', data.dataLayerName)) {
    const dataLayerPush = createQueue(data.dataLayerName);
    const obj = {event: 'originalLocation'};
    obj[data.dataLayerKey] = getUrl();
    dataLayerPush(obj);
  } else {
    log('Invalid permissions for creating ' + data.dataLayerName + ' queue!');
    fail = true;
  }
}

if (fail) { data.gtmOnFailure(); } else { data.gtmOnSuccess(); }


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_referrer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__gtm_campaign_url"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__gtm_referrer"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Do not write cookies if no trigger parameters in URL and if referrer host
    contains current host
  code: |-
    mock('getUrl', component => {
      if (component === 'query') return '?invalidparam=true';
      if (component === 'host') return workingUrl.host;
      return workingUrl.full;
    });

    mock('getReferrerUrl', component => {
      return component === 'host' ? workingUrl.host : mockReferrer.full;
    });

    // Call runCode to run the template's code.
    runCode(mockStoreData);

    assertApi('getUrl').wasCalled();
    assertApi('getReferrerUrl').wasCalled();
    assertApi('queryPermission').wasNotCalled();
    assertApi('setCookie').wasNotCalled();
    assertApi('logToConsole').wasNotCalled();
    assertApi('createQueue').wasNotCalled();

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Write URL cookie if trigger parameters in URL
  code: |-
    mock('getUrl', component => {
      if (component === 'query') return workingUrl.params;
      if (component === 'host') return workingUrl.host;
      return workingUrl.full;
    });

    mock('getReferrerUrl', component => {
      return component === 'host' ? workingUrl.host : mockReferrer.full;
    });

    mock('setCookie', (name, value, options) => {
      if (name === mockStoreData.referrerCookieName) fail('Referrer cookie was set');
      if (name !== mockStoreData.urlCookieName) fail('Cookie name not set');
      if (value !== workingUrl.full) fail('Cookie set with wrong URL');
    });

    // Call runCode to run the template's code.
    runCode(mockStoreData);

    assertApi('getUrl').wasCalled();
    assertApi('getReferrerUrl').wasCalled();
    assertApi('queryPermission').wasCalled();
    assertApi('setCookie').wasCalled();
    assertApi('logToConsole').wasNotCalled();
    assertApi('createQueue').wasNotCalled();

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Fail if invalid permissions to write URL cookie
  code: |-
    mock('getUrl', component => {
      if (component === 'query') return workingUrl.params;
      if (component === 'host') return workingUrl.host;
      return workingUrl.full;
    });

    mock('getReferrerUrl', component => {
      return component === 'host' ? workingUrl.host : mockReferrer.full;
    });

    mock('queryPermission', (permission, cookieName) => {
      if (cookieName === mockStoreData.urlCookieName) return false;
      if (cookieName === mockStoreData.referrerCookieName) fail('Query permission called for referrer cookie');
    });

    mock('logToConsole', false);

    // Call runCode to run the template's code.
    runCode(mockStoreData);

    assertApi('getUrl').wasCalled();
    assertApi('getReferrerUrl').wasCalled();
    assertApi('queryPermission').wasCalled();
    assertApi('setCookie').wasNotCalled();
    assertApi('logToConsole').wasCalled();
    assertApi('createQueue').wasNotCalled();

    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Write referrer cookie if referrer host does not contain current host
  code: |-
    mock('getUrl', component => {
      if (component === 'query') return '?invalidparam=true';
      if (component === 'host') return workingUrl.host;
      return workingUrl.full;
    });

    mock('getReferrerUrl', component => {
      return component === 'host' ? mockReferrer.host : mockReferrer.full;
    });

    mock('setCookie', (name, value, options) => {
      if (name !== mockStoreData.referrerCookieName) fail('Cookie name not set');
      if (name == mockStoreData.urlCookieName) fail('URL cookie set');
      if (value !== mockReferrer.full) fail('Cookie set with wrong URL');
    });

    // Call runCode to run the template's code.
    runCode(mockStoreData);

    assertApi('getUrl').wasCalled();
    assertApi('getReferrerUrl').wasCalled();
    assertApi('queryPermission').wasCalled();
    assertApi('setCookie').wasCalled();
    assertApi('logToConsole').wasNotCalled();
    assertApi('createQueue').wasNotCalled();

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Fail if invalid permissions to write referrer cookie
  code: |-
    mock('getUrl', component => {
      if (component === 'query') return '?invalidparams=true';
      if (component === 'host') return workingUrl.host;
      return workingUrl.full;
    });

    mock('getReferrerUrl', component => {
      return component === 'host' ? mockReferrer.host : mockReferrer.full;
    });

    mock('queryPermission', (permission, cookieName) => {
      if (cookieName === mockStoreData.urlCookieName) fail('Query permission called for URL cookie');
      if (cookieName === mockStoreData.referrerCookieName) return false;
    });

    mock('logToConsole', false);

    // Call runCode to run the template's code.
    runCode(mockStoreData);

    assertApi('getUrl').wasCalled();
    assertApi('getReferrerUrl').wasCalled();
    assertApi('queryPermission').wasCalled();
    assertApi('setCookie').wasNotCalled();
    assertApi('logToConsole').wasCalled();
    assertApi('createQueue').wasNotCalled();

    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Push original location to dataLayer
  code: |-
    mock('getUrl', workingUrl.full);

    mock('createQueue', name => {
      if (name !== mockOriginalData.dataLayerName) fail('Tried to create queue with invalid name');
      return (obj) => {
        if (obj.event !== 'originalLocation') fail('Tried to push invalid event name');
        if (obj[mockOriginalData.dataLayerKey] !== workingUrl.full) fail('Tried to push invalid URL');
      };
    });

    // Call runCode to run the template's code.
    runCode(mockOriginalData);

    assertApi('getUrl').wasCalled();
    assertApi('getReferrerUrl').wasNotCalled();
    assertApi('queryPermission').wasCalled();
    assertApi('setCookie').wasNotCalled();
    assertApi('logToConsole').wasNotCalled();
    assertApi('createQueue').wasCalled();

    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('gtmOnSuccess').wasCalled();
- name: Fail if invalid permissions to write to dataLayer
  code: |-
    mock('queryPermission', (permission, cookieName) => {
      if (permission === 'set_cookies') fail('Permission call for set_cookies made');
      return false;
    });

    mock('logToConsole', false);

    // Call runCode to run the template's code.
    runCode(mockOriginalData);

    assertApi('getUrl').wasNotCalled();
    assertApi('getReferrerUrl').wasNotCalled();
    assertApi('queryPermission').wasCalled();
    assertApi('setCookie').wasNotCalled();
    assertApi('logToConsole').wasCalled();
    assertApi('createQueue').wasNotCalled();

    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
setup: "const mockStoreData = {\n  storeInCookieOption: true,\n  triggerParameters:\
  \ 'utm_source,utm_medium,utm_campaign,utm_term,utm_content,utm_id,gclid',\n\
  \  urlCookieName: '__gtm_campaign_url',\n  referrerCookieName: '__gtm_referrer'\n\
  };\n\nconst mockOriginalData = {\n  originalLocationOption: true,\n  dataLayerName:\
  \ 'dataLayer',\n  dataLayerKey: 'originalLocation'\n};\n  \nconst workingUrl = {\n\
  \  params: '?utm_source=test&utm_medium=test',\n  host: 'www.example.com',\n  full:\
  \ 'https://www.example.com/path/?utm_source=test&utm_medium=test#home'\n};\n\nconst\
  \ mockReferrer = {\n  host: 'www.otherdomain.com',\n  full: 'https://www.otherdomain.com/path/'\n\
  };"


___NOTES___

Created on 30/11/2019, 11:26:05


